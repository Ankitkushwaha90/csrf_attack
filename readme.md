### csrf attack

```cmd
<body onload="document.forms['modify'].submit()" >

<form  name="modify" action="http://reversing.kr/prc/prc_modify.php " method="post">
```
### CSRF Attack: Explanation and Live Example with Source Code
CSRF (Cross-Site Request Forgery) is a type of web security vulnerability where an attacker tricks a user into unknowingly performing an action on a web application in which the user is authenticated. The attacker can force the user to send requests on their behalf, without the user's knowledge, which may lead to unintended consequences such as changing user details or making transactions.

In this tutorial, we'll cover the following:

What is a CSRF attack?
How does a CSRF attack work?
A live example with HTML and PHP code.
How to prevent CSRF attacks.
How Does a CSRF Attack Work?
Victim Authenticated: The victim is authenticated on a target website (e.g., a banking site or social media).
Malicious Request: The attacker tricks the victim into making a request to the target site by embedding a malicious request in a link, form, or script (often on a third-party site).
Unintended Action: Since the victim is already authenticated, the browser automatically sends their cookies with the request, and the target website executes the malicious action, believing it is a legitimate request from the user.
Live Example of a CSRF Attack
Let's assume we have a simple web application that allows users to change their account email address. Without CSRF protection, this page is vulnerable to attack.

### 1. Victim’s Web Application (PHP): Change Email Page
```php
<!-- change-email.php -->
<?php
session_start();
if (!isset($_SESSION['user_id'])) {
    die("You are not logged in.");
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $new_email = $_POST['email'];
    // Update the user's email address (in a real application, use prepared statements to avoid SQL injection)
    // For example, assuming you have a user update function:
    update_user_email($_SESSION['user_id'], $new_email);
    echo "Email updated successfully!";
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change Email</title>
</head>
<body>
    <h2>Change your email</h2>
    <form action="change-email.php" method="POST">
        <label for="email">New Email:</label>
        <input type="email" id="email" name="email" required>
        <button type="submit">Change Email</button>
    </form>
</body>
</html>
```
In this application, a logged-in user can change their email by submitting the form. However, this is vulnerable to a CSRF attack because there's no mechanism to verify that the request originated from a legitimate user.

## 2. Attacker’s Malicious Page (CSRF Attack)
The attacker can create a malicious page that submits a hidden form to the change-email.php page, exploiting the fact that the victim is already authenticated.

```html
<!-- csrf-attack.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSRF Attack</title>
</head>
<body>
    <h1>This is a harmless-looking page</h1>
    <form id="csrfForm" action="http://victim-website.com/change-email.php" method="POST">
        <input type="hidden" name="email" value="attacker@example.com">
    </form>

    <script>
        // Automatically submit the form when the page loads
        document.getElementById("csrfForm").submit();
    </script>
</body>
</html>
```
When the victim, who is logged into victim-website.com, visits the attacker's page (csrf-attack.html), the hidden form is automatically submitted. Since the victim's browser includes the authentication cookies, the request will be processed, and the attacker's email will replace the victim's email.

### Preventing CSRF Attacks
To prevent CSRF attacks, you can implement several defenses:

## 1. CSRF Tokens
A CSRF token is a unique, unpredictable value generated by the server and embedded in each form. This token is verified when the form is submitted to ensure the request is legitimate.

Here's how you can add CSRF protection to the previous example:

PHP Code with CSRF Token Protection:
```php
<!-- change-email.php -->
<?php
session_start();
if (!isset($_SESSION['user_id'])) {
    die("You are not logged in.");
}

if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32)); // Generate a CSRF token
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
        die("CSRF token validation failed!");
    }

    $new_email = $_POST['email'];
    update_user_email($_SESSION['user_id'], $new_email);
    echo "Email updated successfully!";
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change Email</title>
</head>
<body>
    <h2>Change your email</h2>
    <form action="change-email.php" method="POST">
        <label for="email">New Email:</label>
        <input type="email" id="email" name="email" required>
        
        <!-- Add the CSRF token to the form -->
        <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
        
        <button type="submit">Change Email</button>
    </form>
</body>
</html>
```
Now, when the form is submitted, the CSRF token is checked against the one stored in the session. If the tokens don’t match, the request is rejected.

## 2. Same-Site Cookies
Another effective method to prevent CSRF attacks is setting the SameSite attribute on cookies. This restricts cookies from being sent on cross-site requests.

```php
setcookie("session_id", $session_id, [
    'samesite' => 'Strict', // Prevents cookies from being sent with cross-origin requests
    'secure' => true,        // Ensure cookies are sent over HTTPS only
    'httponly' => true       // Prevents access to cookies via JavaScript
]);
```
### Conclusion
A CSRF attack occurs when an attacker tricks a user into performing actions they did not intend. By implementing defenses like CSRF tokens and Same-Site cookies, you can protect your web applications from these attacks.

In the above example, we demonstrated a vulnerable web page and showed how an attacker can exploit it. With the addition of a CSRF token, the application can validate the origin of the request and prevent malicious actions.
